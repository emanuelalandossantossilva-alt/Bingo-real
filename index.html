<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BINGO LIVE - ORIGINAL</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background: #020617; color: #e2e8f0; margin: 0; padding: 10px; text-align: center; }
        .premio-box { background: linear-gradient(90deg, #b45309, #f59e0b, #b45309); color: #fff; padding: 20px; border-radius: 15px; border: 2px solid #facc15; margin-bottom: 20px; }
        .box { background: #1e293b; border-radius: 12px; padding: 15px; border: 1px solid #334155; margin-bottom: 15px; }
        .valor-destaque { color: #22c55e; font-weight: bold; font-size: 1.5rem; }
        input { width: 85%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #fff; text-align: center; }
        .btn { padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; text-transform: uppercase; margin-top: 10px; }
        .btn-green { background: #22c55e; color: white; }
        .btn-blue { background: #3b82f6; color: white; }
        #telaAuth { position: fixed; top:0; left:0; width:100%; height:100%; background:#020617; z-index:1000; display:flex; align-items:center; justify-content:center; }
        .auth-card { background:#1e293b; padding:25px; border-radius:15px; width:90%; max-width:350px; border: 1px solid #334155; }
        .bola { display: inline-flex; width: 35px; height: 35px; align-items: center; justify-content: center; font-weight: bold; margin: 3px; border-radius: 50%; background: #334155; border: 1px solid #facc15; color: white; }
        .sorteada { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        #modalPix { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; padding: 20px; border-radius: 15px; width: 85%; max-width: 320px; border: 2px solid #3b82f6; }
    </style>
</head>
<body>

<div id="telaAuth">
    <div class="auth-card">
        <h2 style="color:#facc15; margin-top:0;">BINGO LIVE</h2>
        <div id="formLogin">
            <input type="email" id="emailLogin" placeholder="E-mail">
            <input type="password" id="senhaLogin" placeholder="Senha">
            <button class="btn btn-green" onclick="autenticar('login')">ENTRAR</button>
            <p style="font-size: 0.8rem; margin-top:10px;">Novo? <a href="#" onclick="alternarAuth('cadastro')" style="color:#3b82f6;">Cadastrar</a></p>
        </div>
        <div id="formCadastro" style="display:none;">
            <input type="text" id="nomeReg" placeholder="Nome Completo">
            <input type="email" id="emailReg" placeholder="E-mail">
            <input type="password" id="senhaReg" placeholder="Senha">
            <button class="btn btn-blue" onclick="autenticar('cadastro')">CRIAR CONTA</button>
            <p style="font-size: 0.8rem; margin-top:10px;"><a href="#" onclick="alternarAuth('login')" style="color:#3b82f6;">Voltar</a></p>
        </div>
    </div>
</div>

<div class="premio-box">
    <small>PRÊMIO TOTAL</small><br>
    <b style="font-size:2.2rem;" id="txtAcumulado">ACUMULANDO...</b>
</div>

<div class="box">
    <div style="display:flex; justify-content: space-between; align-items:center;">
        <div style="text-align:left;">
            <small style="color:#94a3b8;">MEU SALDO:</small><br>
            <span class="valor-destaque" id="saldoUser">R$ 0,00</span>
        </div>
        <div style="text-align:right;">
            <small style="color:#94a3b8;">JOGADOR:</small><br>
            <span id="nomeUser" style="font-weight:bold; color:#facc15;">...</span>
        </div>
    </div>
    <div style="background: #0f172a; padding: 15px; border-radius: 10px; border: 1px solid #4ade80; margin-top:10px;">
        <input type="number" id="qtdCartelas" value="1" min="1" oninput="document.getElementById('totalTxt').innerText = (this.value * 2).toFixed(2)">
        <p>Total: R$ <span id="totalTxt">2,00</span></p>
        <button class="btn btn-blue" onclick="comprarComSaldo()">COMPRAR COM SALDO</button>
        <button class="btn btn-green" onclick="gerarPagamentoCartela()">ADICIONAR VIA PIX</button>
    </div>
</div>

<div class="box">
    <h3 id="txtStatus" style="margin:0; color:#facc15;">INÍCIO EM:</h3>
    <div id="timer" style="font-size: 3.5rem; font-weight: bold; color: #22c55e;">05:00</div>
    <div id="containerBolas"></div>
</div>

<div id="modalPix">
    <div class="modal-content">
        <h3 style="color:#facc15;">PAGAMENTO PIX</h3>
        <div id="loadingPix">Gerando...</div>
        <div id="qrContainer" style="display:none;">
            <div style="background:white; padding:10px; border-radius:10px; margin-bottom:15px;"><img id="imgQr" src="" style="width:100%;"></div>
            <button class="btn btn-blue" onclick="copiarPix()">COPIAR CÓDIGO</button>
        </div>
        <button class="btn" style="background:#475569; color:white;" onclick="id('modalPix').style.display='none'">FECHAR</button>
    </div>
</div>

<script>
    const API = "https://bingo-backend-89dt.onrender.com"; 
    const mp = new MercadoPago('APP_USR-3f875a4f-aff1-4b7b-902e-4494b11b472d');
    let usuarioAtivo = null;
    let pixCopiaCola = "";
    let tempoRestante = 300; // 5 minutos

    function id(el) { return document.getElementById(el); }
    function alternarAuth(tipo) { id('formLogin').style.display = tipo === 'login' ? 'block' : 'none'; id('formCadastro').style.display = tipo === 'cadastro' ? 'block' : 'none'; }

    // Faz o tempo correr na tela
    function iniciarCronometro() {
        setInterval(() => {
            if(tempoRestante > 0) {
                tempoRestante--;
                let min = Math.floor(tempoRestante / 60);
                let seg = tempoRestante % 60;
                id('timer').innerText = `${min.toString().padStart(2,'0')}:${seg.toString().padStart(2,'0')}`;
            }
        }, 1000);
    }

    async function autenticar(tipo) {
        const isLogin = tipo === 'login';
        const body = isLogin ? { email: id('emailLogin').value, senha: id('senhaLogin').value } : { name: id('nomeReg').value, email: id('emailReg').value, senha: id('senhaReg').value };
        try {
            const res = await fetch(`${API}/${isLogin?'login':'register'}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            const data = await res.json();
            if(res.ok) {
                if(isLogin) {
                    usuarioAtivo = data.user;
                    id('nomeUser').innerText = usuarioAtivo.name.toUpperCase();
                    id('saldoUser').innerText = `R$ ${usuarioAtivo.saldo.toFixed(2)}`;
                    id('telaAuth').style.display = 'none';
                    iniciarCronometro();
                    setInterval(sincronizar, 3000);
                } else { alert("Conta criada! Entre agora."); alternarAuth('login'); }
            } else { alert(data.message); }
        } catch (e) { alert("Conectando..."); }
    }

    async function comprarComSaldo() {
        const qtd = id('qtdCartelas').value;
        try {
            const res = await fetch(`${API}/comprar-com-saldo`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ usuarioId: usuarioAtivo._id, quantidade: qtd }) });
            const data = await res.json();
            alert(data.message);
            sincronizar();
        } catch (e) { alert("Erro na compra."); }
    }

    async function gerarPagamentoCartela() {
        const qtd = id('qtdCartelas').value;
        id('modalPix').style.display = 'flex'; id('qrContainer').style.display = 'none'; id('loadingPix').style.display = 'block';
        try {
            const res = await fetch(`${API}/gerar-pix`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ valor: qtd * 2.00, usuarioId: usuarioAtivo._id, quantidade: qtd }) });
            const data = await res.json();
            pixCopiaCola = data.qr_code;
            id('imgQr').src = `data:image/png;base64,${data.qr_code_base64}`;
            id('loadingPix').style.display = 'none'; id('qrContainer').style.display = 'block';
        } catch (e) { alert("Erro! Use o Netlify."); id('modalPix').style.display='none'; }
    }

    function copiarPix() { navigator.clipboard.writeText(pixCopiaCola); alert("Copiado!"); }

    async function sincronizar() {
        try {
            const res = await fetch(`${API}/game-status`);
            const st = await res.json();
            if(st.premioAcumulado > 0) {
                id('txtAcumulado').innerText = `R$ ${st.premioAcumulado.toFixed(2)}`;
            } else {
                id('txtAcumulado').innerText = "ACUMULANDO...";
            }
            if(st.bolas) id('containerBolas').innerHTML = st.bolas.map(b => `<div class="bola sorteada">${b}</div>`).join('');
            const resU = await fetch(`${API}/user-data/${usuarioAtivo._id}`);
            const dataU = await resU.json();
            id('saldoUser').innerText = `R$ ${dataU.saldo.toFixed(2)}`;
        } catch (e) { }
    }
</script>
</body>
</html>
