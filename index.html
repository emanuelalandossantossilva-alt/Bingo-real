<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Real - Oficial</title>
    <style>
        :root { --primary: #facc15; --bg: #020617; --card: #1e293b; --success: #22c55e; }
        body { font-family: sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; padding: 10px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--primary); margin: 10px auto; max-width: 380px; box-sizing: border-box; }
        .hidden { display: none !important; }
        
        .acumulando { color: var(--primary); animation: piscar 1.2s infinite; font-weight: bold; font-size: 20px; }
        @keyframes piscar { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .vitoria-animada { animation: brilhar-ouro 1s infinite alternate; border: 3px solid var(--primary); }
        @keyframes brilhar-ouro { from { box-shadow: 0 0 10px var(--primary); } to { box-shadow: 0 0 30px #ffffff, 0 0 40px var(--primary); } }
        .nome-vencedor { font-size: 32px; color: var(--primary); display: block; margin: 15px 0; text-transform: uppercase; font-weight: bold; }

        .container-cartelas { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
        .cartela { 
            background: #f8fafc; color: #1e293b; padding: 10px; border-radius: 8px; border: 2px solid var(--primary); 
            width: 155px; min-height: 130px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .grid-cartela { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 5px; }
        .numero { font-size: 11px; font-weight: bold; background: #e2e8f0; padding: 4px 0; border-radius: 4px; }
        .marcado { background: var(--success) !important; color: white; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin: 5px 0; text-transform: uppercase; }
        .caixa-premio { background: #064e3b; border: 2px solid var(--success); padding: 15px; border-radius: 10px; margin-bottom: 15px; min-height: 70px; display: flex; align-items: center; justify-content: center; }
        .abas { display: flex; background: #0f172a; border-radius: 8px; padding: 4px; margin-bottom: 10px; }
        .aba { cursor: pointer; padding: 8px; color: #94a3b8; flex: 1; font-size: 11px; font-weight: bold; border-radius: 6px; }
        .aba.ativa { color: #020617; background: var(--primary); }
        .bola-sorteada { width: 25px; height: 25px; background: var(--primary); color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; color: black; width: 80%; max-width: 300px; }
    </style>
</head>
<body>

<div id="modalPix" class="modal hidden">
    <div class="modal-content">
        <h3>Pagamento PIX</h3>
        <img id="qrImagem" style="width:100%" src="">
        <div id="qrTexto" style="font-size:10px; word-break:break-all; margin:10px 0; background:#eee; padding:8px;"></div>
        <button onclick="copiarPix()" style="background:#2563eb; color:white;">COPIAR C√ìDIGO</button>
        <button onclick="document.getElementById('modalPix').classList.add('hidden')" style="background:#ef4444; color:white;">FECHAR</button>
    </div>
</div>

<div id="modalSaque" class="modal hidden">
    <div class="modal-content" style="background: #1e293b; color: white;">
        <h3 style="color: var(--primary);">Solicitar Saque</h3>
        <p style="font-size: 11px; color: #94a3b8;">M√≠nimo para saque: R$ 20,00</p>
        <input type="number" id="saqueValor" placeholder="Valor (R$)">
        <input type="text" id="saqueChave" placeholder="Sua Chave PIX">
        <button onclick="enviarPedidoSaque()" style="background: var(--success); color: white;">PEDIR SAQUE</button>
        <button onclick="document.getElementById('modalSaque').classList.add('hidden')" style="background: #ef4444; color: white;">FECHAR</button>
    </div>
</div>

<div id="modalGanhador" class="modal hidden">
    <div class="modal-content vitoria-animada" style="background: #020617; color: white;">
        <h2>üéä BINGO! üéä</h2>
        <p>Ganhador da Rodada:</p>
        <span id="nomeVencedor" class="nome-vencedor">---</span>
        <button onclick="document.getElementById('modalGanhador').classList.add('hidden')" style="background:var(--primary); color:black;">FECHAR</button>
    </div>
</div>

<div id="telaAuth" class="card">
    <h2 style="color:var(--primary)">BINGO REAL</h2>
    <div class="abas">
        <div id="btnAbaLogin" class="aba ativa" onclick="mudarAbaAuth('login')">LOGIN</div>
        <div id="btnAbaCad" class="aba" onclick="mudarAbaAuth('cad')">CADASTRO</div>
    </div>
    <div id="formLogin">
        <input type="email" id="loginEmail" placeholder="E-mail">
        <input type="password" id="loginSenha" placeholder="Senha">
        <button style="background: #2563eb; color: white;" onclick="fazerLogin()">ENTRAR</button>
    </div>
    <div id="formCad" class="hidden">
        <input type="text" id="cadNome" placeholder="Nome">
        <input type="email" id="cadEmail" placeholder="E-mail">
        <input type="password" id="cadSenha" placeholder="Senha">
        <button style="background: var(--success); color: white;" onclick="fazerCadastro()">CADASTRAR</button>
    </div>
</div>

<div id="telaJogo" class="hidden">
    <div class="card">
        <div class="caixa-premio">
            <div id="suspenseTxt" class="acumulando">ACUMULANDO...</div>
            <div id="valorRevelado" class="hidden">
                <small style="color:#4ade80;">PR√äMIO DA RODADA</small>
                <div id="valorPremio" style="font-size:24px; font-weight:bold;">R$ 0,00</div>
            </div>
        </div>

        <div class="abas">
            <div id="tabSorteio" class="aba ativa" onclick="mudarAba('sorteio')">SORTEIO</div>
            <div id="tabCartelas" class="aba" onclick="mudarAba('cartelas')">CARTELAS</div>
            <div id="tabRanking" class="aba" onclick="mudarAba('ranking')">TOP ACERTOS</div>
        </div>

        <div id="conteudoSorteio">
            <div id="timerTxt" style="font-size:24px; color:var(--primary); font-weight:bold;">05:00</div>
            <div id="bolaGrande" style="font-size:60px; margin:10px 0;">--</div>
            <div id="historicoBolas" style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px;"></div>
        </div>

        <div id="conteudoCartelas" class="hidden">
            <div class="container-cartelas" id="listaCartelas"></div>
        </div>

        <div id="conteudoRanking" class="hidden">
            <div id="listaRanking"></div>
        </div>

        <div style="margin:15px 0;">
            <span id="playerSaldo" style="color:var(--success); font-weight:bold; font-size:18px;">Saldo: R$ 0,00</span>
        </div>

        <button style="background: #2563eb; color: white;" onclick="comprarCartelas()">COMPRAR CARTELA (R$ 2,00)</button>
        <button style="background: #16a34a; color: white;" onclick="gerarPix()">DEPOSITAR</button>
        <button style="background: #9333ea; color: white;" onclick="document.getElementById('modalSaque').classList.remove('hidden')">SACAR SALDO</button>
        <button style="background: transparent; color: #94a3b8; font-size: 10px;" onclick="logout()">SAIR</button>
    </div>
</div>

<script>
    // LINHA DA API CONFIGURADA
    const API = "https://bingo-backend-89dt.onrender.com";
    
    let USER_ID = localStorage.getItem('userId');
    let bolasSorteadas = [];
    let modalGanhadorAberto = false;

    function mudarAbaAuth(tipo) {
        document.getElementById('formLogin').classList.toggle('hidden', tipo !== 'login');
        document.getElementById('formCad').classList.toggle('hidden', tipo !== 'cad');
        document.getElementById('btnAbaLogin').classList.toggle('ativa', tipo === 'login');
        document.getElementById('btnAbaCad').classList.toggle('ativa', tipo === 'cad');
    }

    async function fazerLogin() {
        const res = await fetch(`${API}/login`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: loginEmail.value, senha: loginSenha.value })
        });
        if(res.ok) {
            const d = await res.json();
            localStorage.setItem('userId', d.user._id);
            location.reload();
        } else alert("Erro no login! Verifique e-mail e senha.");
    }

    async function fazerCadastro() {
        const res = await fetch(`${API}/register`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: cadNome.value, email: cadEmail.value, password: cadSenha.value })
        });
        if(res.ok) { alert("Cadastrado! Fa√ßa o login."); mudarAbaAuth('login'); }
        else alert("Erro no cadastro!");
    }

    function logout() { localStorage.removeItem('userId'); location.reload(); }

    function formatarTempo(segundos) {
        const min = Math.floor(segundos / 60).toString().padStart(2, '0');
        const seg = (segundos % 60).toString().padStart(2, '0');
        return `${min}:${seg}`;
    }

    // ATUALIZA√á√ÉO AUTOM√ÅTICA EM 1 SEGUNDO
    async function atualizarInterface() {
        if(!USER_ID) return;
        try {
            // BUSCA SALDO COM TRAVA ANTI-CACHE
            const resUser = await fetch(`${API}/user-data/${USER_ID}?t=${Date.now()}`);
            const user = await resUser.json();
            document.getElementById('playerSaldo').innerText = `Saldo: R$ ${user.saldo.toFixed(2)}`;
            
            const resStatus = await fetch(`${API}/game-status?t=${Date.now()}`);
            const jogo = await resStatus.json();
            bolasSorteadas = jogo.bolas || [];

            if (jogo.ganhadorRodada && !modalGanhadorAberto) {
                document.getElementById('nomeVencedor').innerText = jogo.ganhadorRodada;
                document.getElementById('modalGanhador').classList.remove('hidden');
                modalGanhadorAberto = true;
            }
            if (jogo.fase === 'aguardando') modalGanhadorAberto = false;

            document.getElementById('timerTxt').innerText = formatarTempo(jogo.tempoRestante);
            document.getElementById('bolaGrande').innerText = bolasSorteadas.length > 0 ? bolasSorteadas[bolasSorteadas.length - 1] : "--";
            document.getElementById('historicoBolas').innerHTML = bolasSorteadas.map(b => `<div class="bola-sorteada">${b}</div>`).join('');

            if(user.cartelas && user.cartelas.length > 0) {
                document.getElementById('listaCartelas').innerHTML = user.cartelas.map((c, idx) => {
                    const marcados = c.filter(num => bolasSorteadas.includes(num)).length;
                    return `<div class="cartela">
                        <div style="font-size: 10px; font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 5px;">üë§ ${user.name.toUpperCase()}</div>
                        <div style="display: flex; justify-content: space-between; font-size: 9px;">
                            <span>ID #${idx+1}</span>
                            <span style="color: var(--success); font-weight: bold;">${marcados}/${c.length}</span>
                        </div>
                        <div class="grid-cartela">${c.map(num => `<div class="numero ${bolasSorteadas.includes(num) ? 'marcado' : ''}">${num}</div>`).join('')}</div>
                    </div>`;
                }).join('');
            }
        } catch(e) {}
    }

    async function comprarCartelas() {
        const res = await fetch(`${API}/comprar-com-saldo`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ usuarioId: USER_ID })
        });
        if(res.ok) { alert("Cartela comprada!"); atualizarInterface(); } else alert("Saldo insuficiente!");
    }

    async function gerarPix() {
        const valor = prompt("Valor do dep√≥sito (M√≠nimo 10):", "10");
        if(!valor || valor < 10) return alert("Valor m√≠nimo R$ 10");
        const res = await fetch(`${API}/gerar-pix`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: USER_ID, valor })
        });
        const data = await res.json();
        if(data.qr_code_base64) {
            document.getElementById('qrImagem').src = `data:image/png;base64,${data.qr_code_base64}`;
            document.getElementById('qrTexto').innerText = data.qr_code;
            document.getElementById('modalPix').classList.remove('hidden');
        }
    }

    async function enviarPedidoSaque() {
        const valor = document.getElementById('saqueValor').value;
        const chave = document.getElementById('saqueChave').value;
        const res = await fetch(`${API}/pedir-saque`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: USER_ID, valor, chavePix: chave })
        });
        const data = await res.json();
        if(res.ok) { alert(data.msg); document.getElementById('modalSaque').classList.add('hidden'); } 
        else alert(data.erro);
    }

    function copiarPix() { navigator.clipboard.writeText(document.getElementById('qrTexto').innerText); alert("Copiado!"); }

    function mudarAba(aba) {
        ['Sorteio', 'Cartelas', 'Ranking'].forEach(t => {
            document.getElementById('conteudo'+t).classList.toggle('hidden', aba !== t.toLowerCase());
            document.getElementById('tab'+t).classList.toggle('ativa', aba === t.toLowerCase());
        });
    }

    if(USER_ID) {
        document.getElementById('telaAuth').classList.add('hidden');
        document.getElementById('telaJogo').classList.remove('hidden');
        // ATUALIZA√á√ÉO R√ÅPIDA ATIVADA
        setInterval(atualizarInterface, 1000); 
        atualizarInterface();
    }
</script>
</body>
</html>

